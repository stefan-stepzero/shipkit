# Plan Output Schema

This document defines the JSON schema for implementation plans generated by `shipkit-plan`.

## File Location

```
.shipkit/plans/
├── todo/        # Plan ready, waiting for capacity
├── active/      # Plan being executed
├── parked/      # Blocked or deprioritized
└── shipped/     # Historical record
```

New plans are written to: `.shipkit/plans/todo/{feature}.json`

## Schema Definition

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "required": ["$schema", "type", "version", "lastUpdated", "source", "plan"],
  "properties": {
    "$schema": {
      "type": "string",
      "const": "https://shipkit.io/schemas/plan.json",
      "description": "Schema identifier for tooling"
    },
    "type": {
      "type": "string",
      "const": "plan",
      "description": "Artifact type identifier"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version (semver)"
    },
    "lastUpdated": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last update"
    },
    "source": {
      "type": "string",
      "const": "shipkit-plan",
      "description": "Skill that generated this artifact"
    },
    "plan": {
      "type": "object",
      "required": ["id", "name", "status", "specId", "created", "summary", "codebasePatterns", "phases", "consumptionMap", "specCoverage", "files", "permissions", "validation"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^plan-[a-z0-9-]+$",
          "description": "Unique plan identifier"
        },
        "name": {
          "type": "string",
          "description": "Human-readable plan name"
        },
        "status": {
          "type": "string",
          "enum": ["todo", "active", "parked", "shipped"],
          "description": "Current plan status (matches folder location)"
        },
        "specId": {
          "type": "string",
          "description": "Reference to the spec this plan implements"
        },
        "created": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of creation"
        },
        "updated": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of last update"
        },
        "overview": {
          "type": "object",
          "properties": {
            "goal": {
              "type": "string",
              "description": "1-2 sentence summary from spec"
            },
            "complexity": {
              "type": "string",
              "enum": ["simple", "medium", "complex"],
              "description": "Overall complexity assessment"
            }
          }
        },
        "summary": {
          "type": "object",
          "required": ["phaseCount", "taskCount", "completionPercentage"],
          "properties": {
            "phaseCount": {
              "type": "integer",
              "minimum": 1,
              "description": "Total number of phases"
            },
            "taskCount": {
              "type": "integer",
              "minimum": 1,
              "description": "Total number of tasks across all phases"
            },
            "completionPercentage": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "Percentage of tasks completed"
            },
            "filesCreated": {
              "type": "integer",
              "description": "Number of new files to create"
            },
            "filesModified": {
              "type": "integer",
              "description": "Number of existing files to modify"
            }
          }
        },
        "codebasePatterns": {
          "type": "array",
          "description": "Patterns detected in codebase that plan will follow",
          "items": {
            "type": "object",
            "required": ["concern", "currentPattern", "sourceFile", "planWillUse"],
            "properties": {
              "concern": {
                "type": "string",
                "description": "Area of concern (e.g., 'state', 'data-fetching', 'error-handling', 'auth')"
              },
              "currentPattern": {
                "type": "string",
                "description": "Pattern currently used in codebase"
              },
              "sourceFile": {
                "type": "string",
                "description": "Example file demonstrating the pattern"
              },
              "planWillUse": {
                "type": "string",
                "description": "Pattern this plan will use (should match currentPattern)"
              },
              "divergenceReason": {
                "type": "string",
                "description": "If diverging from current pattern, explain why"
              }
            }
          }
        },
        "phases": {
          "type": "array",
          "minItems": 1,
          "description": "Implementation phases in order",
          "items": {
            "type": "object",
            "required": ["id", "name", "gate", "tasks"],
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^phase-\\d+$",
                "description": "Phase identifier (e.g., 'phase-1')"
              },
              "name": {
                "type": "string",
                "description": "Human-readable phase name"
              },
              "gate": {
                "type": "object",
                "required": ["condition", "verification"],
                "properties": {
                  "condition": {
                    "type": "string",
                    "description": "Specific testable condition for phase completion"
                  },
                  "verification": {
                    "type": "string",
                    "description": "How to verify (command to run or manual check)"
                  }
                }
              },
              "tasks": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "object",
                  "required": ["id", "description", "status", "creates", "consumedBy"],
                  "properties": {
                    "id": {
                      "type": "string",
                      "pattern": "^\\d+\\.\\d+$",
                      "description": "Task identifier (e.g., '1.1', '2.3')"
                    },
                    "description": {
                      "type": "string",
                      "description": "Specific actionable task description"
                    },
                    "status": {
                      "type": "string",
                      "enum": ["pending", "in-progress", "completed", "blocked", "skipped"],
                      "description": "Current task status"
                    },
                    "dependencies": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Task IDs this task depends on"
                    },
                    "creates": {
                      "type": "object",
                      "required": ["artifact", "type"],
                      "properties": {
                        "artifact": {
                          "type": "string",
                          "description": "What this task creates (file path, function name, etc.)"
                        },
                        "type": {
                          "type": "string",
                          "enum": ["file", "function", "type", "config", "component", "hook", "api-endpoint", "test", "migration"],
                          "description": "Type of artifact created"
                        }
                      }
                    },
                    "consumedBy": {
                      "type": "object",
                      "required": ["reference", "type"],
                      "properties": {
                        "reference": {
                          "type": "string",
                          "description": "What consumes this artifact (file:function, task ID, or 'entry-point')"
                        },
                        "type": {
                          "type": "string",
                          "enum": ["file", "task", "entry-point"],
                          "description": "Type of consumer"
                        }
                      }
                    },
                    "files": {
                      "type": "object",
                      "properties": {
                        "create": {
                          "type": "array",
                          "items": { "type": "string" },
                          "description": "File paths to create"
                        },
                        "modify": {
                          "type": "array",
                          "items": { "type": "string" },
                          "description": "File paths to modify"
                        }
                      }
                    },
                    "acceptanceCriteria": {
                      "type": "array",
                      "items": { "type": "string" },
                      "description": "Criteria for task completion"
                    },
                    "estimatedHours": {
                      "type": "number",
                      "maximum": 2,
                      "description": "Estimated hours (must be < 2)"
                    }
                  }
                }
              }
            }
          }
        },
        "consumptionMap": {
          "type": "array",
          "description": "Verification that all created artifacts are consumed",
          "items": {
            "type": "object",
            "required": ["artifact", "type", "consumedBy", "verified"],
            "properties": {
              "artifact": {
                "type": "string",
                "description": "Created artifact name"
              },
              "type": {
                "type": "string",
                "description": "Artifact type"
              },
              "consumedBy": {
                "type": "string",
                "description": "Consumer reference"
              },
              "verified": {
                "type": "boolean",
                "description": "Whether consumption is verified"
              }
            }
          }
        },
        "specCoverage": {
          "type": "array",
          "description": "Mapping of spec requirements to plan tasks",
          "items": {
            "type": "object",
            "required": ["requirement", "taskIds", "covered"],
            "properties": {
              "requirement": {
                "type": "string",
                "description": "Requirement from spec"
              },
              "taskIds": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Task IDs that address this requirement"
              },
              "covered": {
                "type": "boolean",
                "description": "Whether requirement is fully covered"
              }
            }
          }
        },
        "files": {
          "type": "object",
          "required": ["create", "modify"],
          "properties": {
            "create": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["path", "purpose"],
                "properties": {
                  "path": { "type": "string" },
                  "purpose": { "type": "string" }
                }
              }
            },
            "modify": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["path", "changes"],
                "properties": {
                  "path": { "type": "string" },
                  "changes": { "type": "string" }
                }
              }
            }
          }
        },
        "permissions": {
          "type": "object",
          "description": "Pre-declared permissions needed for implementation",
          "properties": {
            "createFiles": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Paths of files to create"
            },
            "modifyFiles": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Paths of files to modify"
            },
            "commands": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Commands to run (tests, build, etc.)"
            },
            "database": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Database operations (migrations, seeds)"
            },
            "dependencies": {
              "type": "array",
              "items": { "type": "string" },
              "description": "New dependencies to install"
            }
          }
        },
        "decisions": {
          "type": "array",
          "description": "Key architectural decisions made in this plan",
          "items": {
            "type": "object",
            "required": ["decision", "rationale"],
            "properties": {
              "decision": {
                "type": "string",
                "description": "What was decided"
              },
              "rationale": {
                "type": "string",
                "description": "Why this choice"
              },
              "alternatives": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Alternatives considered"
              }
            }
          }
        },
        "risks": {
          "type": "array",
          "description": "Identified risks and mitigations",
          "items": {
            "type": "object",
            "required": ["risk", "likelihood", "impact", "mitigation"],
            "properties": {
              "risk": {
                "type": "string",
                "description": "Risk description"
              },
              "likelihood": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              },
              "impact": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              },
              "mitigation": {
                "type": "string",
                "description": "How to mitigate"
              }
            }
          }
        },
        "openQuestions": {
          "type": "array",
          "description": "Unresolved questions that may affect implementation",
          "items": {
            "type": "object",
            "required": ["question", "impact", "resolution"],
            "properties": {
              "question": {
                "type": "string",
                "description": "The open question"
              },
              "impact": {
                "type": "string",
                "description": "How this affects the plan"
              },
              "resolution": {
                "type": "string",
                "enum": ["blocking", "can-proceed", "resolved"],
                "description": "Resolution status"
              },
              "owner": {
                "type": "string",
                "description": "Who should resolve this"
              }
            }
          }
        },
        "validation": {
          "type": "object",
          "required": ["consumption", "granularity", "existence", "phaseGates", "specCoverage", "patternAlignment", "permissions", "status"],
          "description": "Validation results from all checks",
          "properties": {
            "consumption": {
              "type": "object",
              "properties": {
                "creates": { "type": "integer" },
                "consumed": { "type": "integer" },
                "orphans": { "type": "integer" },
                "passed": { "type": "boolean" }
              }
            },
            "granularity": {
              "type": "object",
              "properties": {
                "totalSteps": { "type": "integer" },
                "oversized": { "type": "integer" },
                "passed": { "type": "boolean" }
              }
            },
            "existence": {
              "type": "object",
              "properties": {
                "references": { "type": "integer" },
                "verified": { "type": "integer" },
                "passed": { "type": "boolean" }
              }
            },
            "phaseGates": {
              "type": "object",
              "properties": {
                "totalPhases": { "type": "integer" },
                "testableGates": { "type": "integer" },
                "passed": { "type": "boolean" }
              }
            },
            "specCoverage": {
              "type": "object",
              "properties": {
                "totalRequirements": { "type": "integer" },
                "mapped": { "type": "integer" },
                "passed": { "type": "boolean" }
              }
            },
            "patternAlignment": {
              "type": "object",
              "properties": {
                "aligned": { "type": "boolean" },
                "divergences": { "type": "integer" },
                "justified": { "type": "boolean" },
                "passed": { "type": "boolean" }
              }
            },
            "permissions": {
              "type": "object",
              "properties": {
                "newFiles": { "type": "integer" },
                "modifiedFiles": { "type": "integer" },
                "commands": { "type": "integer" },
                "passed": { "type": "boolean" }
              }
            },
            "status": {
              "type": "string",
              "enum": ["valid", "invalid"],
              "description": "Overall validation status"
            }
          }
        }
      }
    }
  }
}
```

## Field Descriptions

### Top-Level Envelope

| Field | Description |
|-------|-------------|
| `$schema` | Schema URL for tooling and validation |
| `type` | Artifact type (`plan`) |
| `version` | Schema version in semver format |
| `lastUpdated` | ISO 8601 timestamp |
| `source` | Generating skill (`shipkit-plan`) |

### Plan Object

| Field | Description |
|-------|-------------|
| `id` | Unique identifier (e.g., `plan-user-auth`) |
| `name` | Human-readable name |
| `status` | Plan lifecycle status |
| `specId` | Reference to source spec |
| `created` | Creation timestamp |
| `updated` | Last modification timestamp |

### Summary

Quick stats for plan overview:
- `phaseCount`: Number of implementation phases
- `taskCount`: Total tasks across all phases
- `completionPercentage`: Progress tracking (0-100)

### Phases and Tasks

Each phase contains:
- `gate`: Testable completion condition with verification method
- `tasks`: Array of specific, actionable tasks

Each task contains:
- `id`: Task identifier (e.g., "1.1", "2.3")
- `status`: Current task status
- `dependencies`: Other tasks that must complete first
- `creates`: What artifact this task produces
- `consumedBy`: What uses this artifact
- `files`: Files to create or modify
- `acceptanceCriteria`: When task is done

### Validation

All six validation checks from the skill:
1. **Consumption**: No orphaned artifacts
2. **Granularity**: All tasks < 2 hours
3. **Existence**: All code references verified
4. **Phase Gates**: All phases have testable gates
5. **Spec Coverage**: All requirements mapped
6. **Pattern Alignment**: Matches codebase patterns
